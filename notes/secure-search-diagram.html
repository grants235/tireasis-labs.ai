<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Similarity Search Architecture</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #0a0a0a;
            color: #e0e0e0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #4a9eff;
            margin-bottom: 40px;
        }
        .flow-diagram {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(74, 158, 255, 0.1);
        }
        .flow-step {
            background: #252525;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        .flow-step::after {
            content: '‚Üì';
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: #4a9eff;
        }
        .flow-step:last-child::after {
            display: none;
        }
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: #4a9eff;
        }
        .step-side {
            font-size: 14px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        .client {
            background: #1e3a5f;
            color: #7fb3ff;
        }
        .server {
            background: #3f1e5f;
            color: #b37fff;
        }
        .data-box {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            overflow-x: auto;
        }
        .data-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .highlight {
            color: #4a9eff;
            font-weight: 600;
        }
        .security-note {
            background: #1e3a5f;
            border-left: 4px solid #4a9eff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .performance-note {
            background: #3f1e5f;
            border-left: 4px solid #b37fff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .api-endpoint {
            color: #7fb3ff;
            font-weight: 600;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Secure Similarity Search Architecture</h1>
        
        <div class="flow-diagram">
            <h2 style="color: #4a9eff; margin-bottom: 30px;">1Ô∏è‚É£ Initialization Phase</h2>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">Client Prepares HE Context</div>
                    <div class="step-side client">CLIENT</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Actions:</div>
                    <pre>‚Ä¢ Generate CKKS context (8192 poly degree)
‚Ä¢ Create public/private key pair
‚Ä¢ Set scale = 2^40 for precision
‚Ä¢ Generate Galois keys for rotations</pre>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">POST <span class="api-endpoint">/initialize</span></div>
                    <div class="step-side client">CLIENT ‚Üí SERVER</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Request Payload:</div>
                    <pre>{
  "context_params": {
    <span class="highlight">"public_key"</span>: "base64_encoded_public_key",
    "scheme": "CKKS",
    "poly_modulus_degree": 8192
  },
  "embedding_dim": 384,
  "lsh_config": {
    <span class="highlight">"num_tables"</span>: 20,
    <span class="highlight">"hash_size"</span>: 16,
    <span class="highlight">"num_candidates"</span>: 100
  }
}</pre>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">Server Initializes</div>
                    <div class="step-side server">SERVER</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Actions:</div>
                    <pre>‚Ä¢ Load public key (no private key!)
‚Ä¢ Generate random hyperplanes for LSH
‚Ä¢ Initialize hash tables
‚Ä¢ Prepare encrypted vector storage</pre>
                </div>
            </div>
        </div>
        
        <div class="flow-diagram">
            <h2 style="color: #4a9eff; margin-bottom: 30px;">2Ô∏è‚É£ Adding Embeddings</h2>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">Client Processes Embedding</div>
                    <div class="step-side client">CLIENT</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Actions:</div>
                    <pre>‚Ä¢ Normalize embedding to unit vector
‚Ä¢ <span class="highlight">Encrypt with HE</span>: vector ‚Üí CKKS ciphertext
‚Ä¢ <span class="highlight">Compute LSH hashes</span>: 20 hash values
‚Ä¢ Serialize & base64 encode</pre>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">POST <span class="api-endpoint">/add_embedding</span></div>
                    <div class="step-side client">CLIENT ‚Üí SERVER</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Request Payload:</div>
                    <pre>{
  <span class="highlight">"encrypted_embedding"</span>: "base64_encoded_encrypted_vector",
  <span class="highlight">"lsh_hashes"</span>: [12345, 67890, 34567, ...], // 20 values
  "metadata": {
    "text": "Example sentence",
    "category": "science"
  },
  "embedding_id": "sent_001"
}</pre>
                </div>
                <div class="security-note">
                    üîí <strong>Security:</strong> Server receives only encrypted embedding. LSH hashes are safe to send in plaintext as they only preserve locality, not content.
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">Server Indexes Data</div>
                    <div class="step-side server">SERVER</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Actions:</div>
                    <pre>‚Ä¢ Store encrypted embedding in database
‚Ä¢ Add to LSH index: hash ‚Üí [embedding_ids]
‚Ä¢ Store metadata separately
‚Ä¢ Return confirmation</pre>
                </div>
            </div>
        </div>
        
        <div class="flow-diagram">
            <h2 style="color: #4a9eff; margin-bottom: 30px;">3Ô∏è‚É£ Similarity Search</h2>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">Client Prepares Query</div>
                    <div class="step-side client">CLIENT</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Actions:</div>
                    <pre>‚Ä¢ Normalize query embedding
‚Ä¢ Encrypt with same HE context
‚Ä¢ Compute LSH hashes (same algorithm)</pre>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">POST <span class="api-endpoint">/search</span></div>
                    <div class="step-side client">CLIENT ‚Üí SERVER</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Request Payload:</div>
                    <pre>{
  <span class="highlight">"encrypted_query"</span>: "base64_encoded_encrypted_query",
  <span class="highlight">"lsh_hashes"</span>: [11111, 22222, 33333, ...],
  "top_k": 10,
  "rerank_candidates": 100
}</pre>
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">Server Performs Hybrid Search</div>
                    <div class="step-side server">SERVER</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Step 1: LSH Filtering (Fast)</div>
                    <pre>‚Ä¢ Check 20 hash tables for matches
‚Ä¢ Collect candidate IDs
‚Ä¢ <span class="highlight">10,000 ‚Üí ~100 candidates</span></pre>
                </div>
                <div class="data-box">
                    <div class="data-label">Step 2: HE Computation (Slow but fewer)</div>
                    <pre>‚Ä¢ For each candidate:
  - Load encrypted embedding
  - Compute <span class="highlight">encrypted_query ‚Ä¢ encrypted_embedding</span>
  - Result is encrypted similarity score
‚Ä¢ Cannot decrypt or sort!</pre>
                </div>
                <div class="performance-note">
                    ‚ö° <strong>Performance:</strong> LSH reduces HE computations by ~100x. Only compute expensive dot products on likely matches.
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">Server Returns Results</div>
                    <div class="step-side server">SERVER ‚Üí CLIENT</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Response Payload:</div>
                    <pre>{
  "results": [
    {
      "embedding_id": "sent_042",
      <span class="highlight">"encrypted_similarity"</span>: "base64_encoded_encrypted_score",
      "metadata": {"text": "Similar sentence 42"}
    },
    // ... ~20 results (2x requested for client sorting)
  ],
  "candidates_checked": 87,
  "search_time_ms": 1250.5
}</pre>
                </div>
                <div class="security-note">
                    üîí <strong>Security:</strong> Server cannot see similarity scores or determine which results are best. Returns extra results for client to decrypt and sort.
                </div>
            </div>
            
            <div class="flow-step">
                <div class="step-header">
                    <div class="step-title">Client Decrypts & Ranks</div>
                    <div class="step-side client">CLIENT</div>
                </div>
                <div class="data-box">
                    <div class="data-label">Actions:</div>
                    <pre>‚Ä¢ Decrypt each similarity score
‚Ä¢ Sort by similarity (descending)
‚Ä¢ Return top-k results to user
‚Ä¢ Display with metadata</pre>
                </div>
            </div>
        </div>
        
        <div class="flow-diagram" style="background: #1e3a5f;">
            <h2 style="color: #7fb3ff; margin-bottom: 20px;">üîë Key Security Properties</h2>
            <ul style="line-height: 1.8;">
                <li><strong>Zero Knowledge:</strong> Server never sees plaintext embeddings or queries</li>
                <li><strong>Encrypted Computation:</strong> Similarities computed on encrypted data</li>
                <li><strong>No Ranking Leak:</strong> Server cannot determine result quality</li>
                <li><strong>LSH Safety:</strong> Hash values only preserve locality, not content</li>
                <li><strong>Forward Security:</strong> Past queries don't compromise future ones</li>
            </ul>
        </div>
        
        <div class="flow-diagram" style="background: #3f1e5f;">
            <h2 style="color: #b37fff; margin-bottom: 20px;">‚ö° Performance Characteristics</h2>
            <ul style="line-height: 1.8;">
                <li><strong>LSH Filtering:</strong> ~100ms for 10K embeddings</li>
                <li><strong>HE Computation:</strong> ~10ms per candidate dot product</li>
                <li><strong>Total Search Time:</strong> ~1-2 seconds for 10K database</li>
                <li><strong>Speedup:</strong> 100x faster than full HE search</li>
                <li><strong>Scalability:</strong> Linear with candidates, not database size</li>
            </ul>
        </div>
    </div>
</body>
</html>